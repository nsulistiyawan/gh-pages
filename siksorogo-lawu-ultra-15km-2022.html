<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siksorogo Lawu Ultra 15km - 2022</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"> </script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <div style="display: none;">
        Hayooo view source code
    </div>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken =
            'pk.eyJ1IjoibnN1bGlzdGl5YXdhbiIsImEiOiJjbGFubG8xc2YwbXlmM3huNnBnOW9vb29hIn0.qEhtiQPKWTfZNBx5d2iD1A';
        (async () => {
            const map = new mapboxgl.Map({
                container: 'map',
                zoom: 13.1,
                center: [110.43, -7.45],
                pitch: 76,
                bearing: 150,
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                interactive: false,
                hash: false
            });

            const [hikeRoute] = await Promise.all([
                fetch(
                    'https://raw.githubusercontent.com/nsulistiyawan/nsulistiyawan.github.io/master/siksorogo-15km-2022.geojson'
                ).then((response) => response.json()),
                map.once('style.load')
            ]);

            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.terrain-rgb',
                'tileSize': 512,
                'maxzoom': 13
            });
            map.setTerrain({
                'source': 'mapbox-dem',
                'exaggeration': 1.5
            });

            const pinRoute = hikeRoute.features[0].geometry.coordinates;
            const popup = new mapboxgl.Popup({
                closeButton: false
            });
            const marker = new mapboxgl.Marker({
                    color: 'orange',
                    scale: 1,
                    draggable: false,
                    pitchAlignment: 'auto',
                    rotationAlignment: 'auto'
                })
                .setLngLat(pinRoute[0])
                .setPopup(popup)
                .addTo(map)
                .togglePopup();

            map.addSource('line', {
                type: 'geojson',
                lineMetrics: true,
                data: hikeRoute
            });
            map.addLayer({
                type: 'line',
                source: 'line',
                id: 'line',
                paint: {
                    'line-color': 'rgba(0,0,0,0)',
                    'line-width': 1
                },
                layout: {
                    'line-cap': 'round',
                    'line-join': 'round'
                }
            });

            await map.once('idle');

            const animationDuration = 25000;

            const path = turf.lineString(pinRoute);
            const pathDistance = turf.lineDistance(path);

            let start;

            function frame(time) {
                if (!start) start = time;
                const animationPhase = (time - start) / animationDuration;
                if (animationPhase > 1) {
                    return;
                }

                const alongPath = turf.along(path, pathDistance * animationPhase)
                    .geometry.coordinates;
                const lngLat = {
                    lng: alongPath[0],
                    lat: alongPath[1]
                };

                const elevation = Math.floor(
                    map.queryTerrainElevation(lngLat, {
                        exaggerated: false
                    })
                );

                popup.setHTML('Ketinggian: ' + elevation + 'm<br/>');
                marker.setLngLat(lngLat);

                map.setPaintProperty('line', 'line-gradient', [
                    'step',
                    ['line-progress'],
                    'red',
                    animationPhase,
                    'rgba(255, 0, 0, 0)'
                ]);

                const rotation = 111 - animationPhase * 40.0;
                map.setBearing(rotation % 360);

                window.requestAnimationFrame(frame);
            }

            window.requestAnimationFrame(frame);
        })();
    </script>

</body>

</html>